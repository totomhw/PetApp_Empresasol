@model PetApp_Empresa.Models.CarritoDeCompra

<h2>Resumen del Carrito</h2>

@if (Model.CarritoAccesorios != null && Model.CarritoAccesorios.Any())
{
    <table class="table">
        <thead>
            <tr>
                <th>Producto</th>
                <th>Cantidad</th>
                <th>Precio Unitario</th>
                <th>Subtotal</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var item in Model.CarritoAccesorios)
            {
                <tr>
                    <td>@item.Accesorio.Nombre</td>
                    <td>@item.Cantidad</td>
                    <td>@item.Accesorio.Precio.ToString("C")</td>
                    <td>@(item.Accesorio.Precio * item.Cantidad).ToString("C")</td>
                </tr>
            }
        </tbody>
    </table>

    <h3>Total: @(Model.Total.HasValue ? Model.Total.Value.ToString("C") : "N/A")</h3>

    <form id="formConfirmarCompra" asp-action="ConfirmarCompra" method="post">
        @Html.AntiForgeryToken()

        <div class="form-group">
            <label>¿Deseas usar una tarjeta guardada o ingresar una nueva?</label>
            <div>
                <input type="radio" id="opcionTarjetaGuardada" name="opcionTarjeta" value="guardada" checked />
                <label for="opcionTarjetaGuardada">Usar tarjeta guardada</label>
            </div>
            <div>
                <input type="radio" id="opcionTarjetaNueva" name="opcionTarjeta" value="nueva" />
                <label for="opcionTarjetaNueva">Ingresar nueva tarjeta</label>
            </div>
        </div>

        <div id="tarjetasGuardadas" class="form-group">
            @if (ViewBag.Tarjetas != null && ((List<PetApp_Empresa.Models.Tarjeta>)ViewBag.Tarjetas).Any())
            {
                <label for="tarjetaId">Selecciona una tarjeta guardada:</label>
                <select class="form-control" id="tarjetaId" name="tarjetaId">
                    <option value="">-- Seleccione una tarjeta --</option>
                    @foreach (var tarjeta in ViewBag.Tarjetas as List<PetApp_Empresa.Models.Tarjeta>)
                    {
                        <option value="@tarjeta.TarjetaId">
                            Número: **** **** **** @tarjeta.Numero.Substring(tarjeta.Numero.Length - 4) - Vence: @tarjeta.FechaVencimiento
                        </option>
                    }
                </select>
            }
            else
            {
                <p>No hay tarjetas guardadas disponibles.</p>
            }
        </div>


        <div id="nuevaTarjeta" class="form-group">
            <label for="numeroTarjeta">Número de Tarjeta</label>
            <input type="text" class="form-control" id="numeroTarjeta" name="numeroTarjeta" maxlength="16" pattern="\d{16}" />

            <label for="mesVencimiento">Mes de Vencimiento</label>
            <select class="form-control" id="mesVencimiento" name="mesVencimiento">
                <option value="" disabled selected>-- Mes --</option>
                @for (int mes = 1; mes <= 12; mes++)
                {
                    <option value="@mes">@mes.ToString("D2")</option>
                }
            </select>

            <label for="anioVencimiento">Año de Vencimiento</label>
            <select class="form-control" id="anioVencimiento" name="anioVencimiento">
                <option value="" disabled selected>-- Año --</option>
                @for (int anio = DateTime.Now.Year; anio <= DateTime.Now.Year + 10; anio++)
                {
                    <option value="@anio.ToString().Substring(2)">@anio.ToString("D2")</option>
                }
            </select>


            <label for="cvv">CVV</label>
            <input type="text" class="form-control" id="cvv" name="cvv" maxlength="3" pattern="\d{3}" />

            <!-- Checkbox para guardar tarjeta -->
            <div class="form-check mt-3">
                <input type="checkbox" class="form-check-input" id="guardarTarjeta" name="guardarTarjeta" value="true" />
                <label class="form-check-label" for="guardarTarjeta">Guardar tarjeta para futuras compras</label>
            </div>
        </div>

        <button type="submit" class="btn btn-success">Realizar Pago</button>
    </form>
}
else
{
    <p>El carrito está vacío.</p>
}

<script>
    document.querySelectorAll('input[name="opcionTarjeta"]').forEach(option => {
        option.addEventListener('change', () => {
            const tarjetasGuardadas = document.getElementById('tarjetasGuardadas');
            const nuevaTarjeta = document.getElementById('nuevaTarjeta');

            if (document.getElementById('opcionTarjetaGuardada').checked) {
                tarjetasGuardadas.style.display = 'block';
                nuevaTarjeta.style.display = 'none';
            } else {
                tarjetasGuardadas.style.display = 'none';
                nuevaTarjeta.style.display = 'block';
            }
        });
    });

    document.getElementById('formConfirmarCompra').addEventListener('submit', (event) => {
        const opcionGuardada = document.getElementById('opcionTarjetaGuardada').checked;
        const tarjetaId = document.getElementById('tarjetaId')?.value;
        const numeroTarjeta = document.getElementById('numeroTarjeta')?.value;

        if (opcionGuardada && (!tarjetaId || tarjetaId.trim() === '')) {
            event.preventDefault();
            alert("Debes seleccionar una tarjeta guardada antes de realizar la compra.");
        }

        if (!opcionGuardada && (!numeroTarjeta || numeroTarjeta.trim() === '')) {
            event.preventDefault();
            alert("Debes ingresar los datos de la nueva tarjeta.");
        }
    });
</script>
